(ns raspispy.core
  (:require [cljs.nodejs :as nodejs]))

(defonce noble (nodejs/require "noble"))

(nodejs/enable-util-print!)

(defn get-state []
  (keyword (.-state noble)))

(defn on-discover [peripheral]
  (println "Discovered" peripheral)
  (println "foo")
  ;;(.discoverServices peripheral)
  ;;(.discoverAllServicesAndCharacteristics peripheral)
  )

(defn start-discovery! []
  (println "Starting discovery!")
  (.on noble "discover" on-discover))

(defn on-scan-start []
  (start-discovery!))

(defn start-scanning! []
  (println "Starting scanning!")
  (.on noble "scanStart" on-scan-start)
  (.startScanning noble [] true))

(defn stop-scanning! []
  (println "Stopping scanning!")
  (.stopScanning noble))

(defn on-state-change []
  (if (= (get-state) :poweredOn)
    (start-scanning!)
    (stop-scanning!)))

(defn spy []
  (println "Starting spying...")
  (.on noble "stateChange" on-state-change))

(defn -main []
  (spy))

(set! *main-cli-fn* -main)

